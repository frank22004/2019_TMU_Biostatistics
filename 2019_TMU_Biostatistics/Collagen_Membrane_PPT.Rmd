---
title: "Stiffness Gradient Collagen Membrane"
author: "Frank"
date: "`r Sys.Date()`"
output: html_notebook
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

## Loading `r version[['version.string']]` and following packages, Set up the connection:

```{r cars, echo = TRUE}
library(RODBC)
library(UsingR)
library(ggpubr)
library(ggplot2)
library(ggsignif)
library(dplyr)
library(ggeasy)
library(ggplot2)
library(rstatix)
library(stringr)
library(fitdistrplus)
library(knitr)
library(multcomp)
library(xlsx)
library(grid)
library(ggbreak)
library(plotrix)
library(ggpattern)
library(gee)
library(geepack)
library(stats)
```

1.  Set up driver info and database path

```{r access_path}
DRIVERINFO <- "Driver={Microsoft Access Driver (*.mdb, *.accdb)};"
MDBPATH <- "E:/OneDrive/文件/TMU-DESKTOP-SF2LD60-Surface-Go-Surface-Go.accdb"
PATH <- paste0(DRIVERINFO, "DBQ=", MDBPATH)
```

2.  Establish connection

```{r connection}
channel <- odbcDriverConnect(PATH)
```

3.  Load data into R dataframe

```{r Load}
df <- sqlQuery(channel,"SELECT * FROM CollagenMembrane, AFM WHERE CollagenMembrane.Cantilever=AFM.No;", stringsAsFactors = FALSE)
df_sample <- sqlQuery(channel,"SELECT * FROM Sample, Collagen_Membrane_Preparation WHERE Sample.Scaffolds=Collagen_Membrane_Preparation.識別碼;")
df_dish <- sqlQuery(channel, "SELECT * FROM DishDepth;", stringsAsFactors = FALSE)
df_all <- merge(df,df_sample,by.x="Experiment Sample",by.y = "識別碼",all.x = "TRUE")
df_drug <- sqlQuery(channel, "SELECT * FROM Drug, Material WHERE Drug.Drug = Material.MaterialID;")
df_all_withdrug <- merge(df_all, df_drug,by.x = "GroupName.y", by.y = "ExperimentSample", all.x = "TRUE")
```

```{r}
allStatus <- paste(df_all_withdrug$Status.x,df_all_withdrug$Status.y)
df_all_withdrug <- cbind(df_all_withdrug,allStatus)
```

4.  Calculate the thickness: 
  -   Experiment Sample = 225  & 223 & 233 & 235 & 230 (GM6001 Treatment)
  -   Normal Group (compresed) = 125 & 126 & 138 & 144 & 110 & 109
  -   Normal Group (Uncompressed) = 127 & 128 & 234 & 108 & 107
  -   Coating:
    - 80% = 189
    - 50% = 188
    - 20% = 187

```{r Experiment Sample}
#For compared the surroundings area of spheroid and distal area
#df_data <- subset.data.frame(df_all[-c(1262),], `Ingredient` == "CollagenInStretch_flat" & !(`Status.y`=="AFM") & !(`Experiment Sample`== 100)& !(`Experiment Sample`== 99)& !(`Experiment Sample`== 98))

#The general collagen stiffness without cell
#df_data <- subset.data.frame(df_all,(`Ingredient` == "CollagenInStretch_flat"  & `Status.y`=="Compressed"& `Centrifuge (rpm)`!=3000)|(`Ingredient` == "CollagenInStretch_flat"  & `Status.y`=="Uncompressed")
#                             |`Ingredient` =="5%HAPInStretch"
#                              | `Experiment Sample`== 187  | `Experiment Sample`== 189
#                             )

#colnames(df_data)[which(names(df_data)=="Centrifuge (rpm)")]<-"Centrifuge.RPM"
#|`Ingredient` =="5%HAPInStretch"
#Distance related stiffness
#df_data <- subset.data.frame( df_all_withdrug,`Experiment Sample`== "287"|`Experiment Sample`== "288")

# The stiffness change before and after spheroid culture
df_data <- subset.data.frame( df_all_withdrug,(
#  (
    `Ingredient`== "polyacryalmide" 
#    | `Ingredient` == "ScrappingCoating" & `Experiment Sample`!= 188 )
& `Status.y` != "Discard" & `Status.y` != "Culturing"  & `Status.x` != "Plamsa"& `Cantilever.1` != 4
) 
#
#& `allStatus` != "PreCoat 20%Coat" & `allStatus` != "PreCoat 80%Coat")
#  (`Ingredient` == "CollagenInStretch_flat"  & `Status.y`=="Compressed"& `Centrifuge (rpm)`!=3000)|(`Ingredient` == "CollagenInStretch_flat"  & `Status.y`=="Uncompressed")) | (`Experiment Sample`=="234"   | `Experiment Sample`== "125"| `Experiment Sample`== "126"| `Experiment Sample`== "138"| `Experiment Sample`== "144"| `Experiment Sample`== "127" | `Experiment Sample`== "128" | `Experiment Sample`== "107" | `Experiment Sample`== "108" | `Experiment Sample`== "109"| `Experiment Sample`== "110" | `Experiment Sample`== "287"  | `Experiment Sample`== "288" ) & (df_all_withdrug$Yasix == 0 ) & !(is.na(df_all_withdrug$YoungsModulus)))
#                             | `Experiment Sample`== "225"| `Experiment Sample`== "235"| `Experiment Sample`== "233"| `Experiment Sample`== "230" |

                            )
#df_data$culture <- ifelse((df_data$Status.y=="Compressed"|df_data$Status.y=="Uncompressed"),
#                          (ifelse(df_data$Status.x=="7days","Post","Pre")),"Spheroid")
#df_data$Status <- ifelse(df_data$Status.y=="Compressed","Compressed",
#                         ifelse(df_data$Status.y=="Uncompressed","Uncompressed",
#                                ifelse(df_data$Status.y=="UncompressedWithCell","Uncompressed",
#                                       ifelse(df_data$Status.y=="CompressedWithCell","Compressed",""))))
#df_data <- df_data[df_data$culture == "Pre",]


#df_data_PA <- subset.data.frame(df_all_withdrug,`Experiment Sample`=="303" | `Experiment Sample`=="302")
#df_data_PA$culture <- "Pre"
#df_data_PA$Status <- "Polyacrylamide"
#df_data$`Thickness` <- df_dish[which(df_dish$Date=="2024-07-15"),]$'Dish Depth (μm)' - df_data$`AFMfathomDepth`
#df_data$`Thickness` <- 7654.31 - df_data$`AFMfathomDepth`

df_data$Status.y <- factor(df_data$Status.y, levels = c("20%Coat","80%Coat"))
df_data$Status.x <- factor(df_data$Status.x, levels = c("PreCoat","Coated"))
 
#substrate the thickness of a cover slide
#df_data <- rbind(df_data,df_data_PA)
#df_data$Ingredient <- factor(df_data$Ingredient, levels = c("polyacryalmide","ScrappingCoating"))
df_data
#colnames(df_data)[which(names(df_data)=="2MiddleLow")]<-"Middle"
#colnames(df_data)[which(names(df_data)=="3MiddleHigh")]<-"Middle"
#df_data$Area[which(df_data$Area=="2MiddleLow")] <- "Middle"
#df_data$Area[which(df_data$Area=="3MiddleHigh")] <- "Middle"
#df_data$Area[which(df_data$Area=="1Lowest")] <- "Low"
#df_data$Area[which(df_data$Area=="4Highest")] <- "High"
#df_data$Area <- factor(df_data$Area, levels = c("Low","Middle","High"))
#df[df$`Experiment Sample`=="287"|df$`Experiment Sample`=="288",]$Thickness <- df_dish[which(df_dish$Date=="2024-07-15"),]$'Dish Depth (μm)' - df_data$`AFMfathomDepth`
#df[df$`Experiment Sample`==144,]$Thickness <- 7554.31 - df_data$`AFMfathomDepth`
```

5.  Table on the Data of Youngs Modulus
Don't consider the group 100, 99, and 98 because I didn't measure under the peripheral or distal area of the spheroid
```{r Table}
#df_data <- subset.data.frame(df, Area != "" & Area != "1Lowest"& Area != "2MiddleLow"& Area != "3MiddleHigh"& Area != "4Highest")
#df_data$Area <- factor(df_data$Yasix, levels = c("0","100","150"))

### For test the 7 culture differences
#df_data$culture <- factor(df_data$culture,levels = c("Pre","Post","Spheroid"))
#df_data$Status <- factor(df_data$Status, levels = c("Uncompressed","Compressed"))
#df_data$Status.y <- factor(df_data$Status.y, levels = c("Uncompressed","Compressed"))

#For compared the surroundings area of spheroid and distal area
#df_data$allStatus <- factor(df_data$allStatus, levels = c("Compressed Compressed", "Uncompressed Uncompressed",
#                                                          "Peripheral CompressedWithCell", 
#                                                          "Distal CompressedWithCell",
#                                                          "Peripheral UncompressedWithCell",
#                                                          "Distal UncompressedWithCell"))
#df_data <- df_data[-19,]



SynthesisMatrix <- df_data %>%
#  group_by(MaterialName,Status.y,Yasix) %>%
#  group_by(Status.y,Centrifuge.RPM,Ingredient) %>%
#  group_by(Status.x) %>%
#   group_by(Status,culture) %>%
  group_by(Status.y, Status.x, allStatus) %>%
  summarise(
    count = sum(!is.na(`YoungsModulus`)),
    N = n_distinct(`Experiment Sample`,na.rm = TRUE),
    mean = mean(`YoungsModulus`, na.rm = TRUE),
    sd = sd(`YoungsModulus`, na.rm = TRUE),
    median = median(`YoungsModulus`, na.rm = TRUE),
    IQR = IQR(`YoungsModulus`, na.rm = TRUE),
    se = sd(`YoungsModulus`, na.rm = TRUE)/sqrt(count),
    normality = shapiro.test(`YoungsModulus`)$p.value
  )
SynthesisMatrix
```

6.  Table on the Data of Thickness

```{r}
#df_data$Status.y <- factor(df_data$Status.y, levels = c("Uncompressed","Compressed","20%Coat","80%Coat"))

thickMatrix <- df_data %>%
#  group_by(MaterialName, Status.y,Yasix) %>%
#  group_by(allStatus) %>%
#  group_by(Status,culture) %>%
  group_by(Ingredient, Status.y, allStatus) %>%
  summarise(
    count = sum(!is.na(Thickness)),
    N = n_distinct(`Experiment Sample`,na.rm = TRUE),
    mean = mean(Thickness, na.rm = TRUE),
    sd = sd(Thickness, na.rm=TRUE),
    median = median(Thickness, na.rm=TRUE),
    IQR = IQR(Thickness, na.rm = TRUE),
    se = sd/sqrt(count),
    normality = shapiro.test(`Thickness`)$p.value
  )
thickMatrix
```

## Divide into the subgroups and Check the normality

```{r divided}
low <- subset.data.frame(df_data, Status.y=="CompressedWithCell")
#Mid <- subset.data.frame(df_data, Status.x=="Uncompressed")
High <- subset.data.frame(df_data, Status.y=="Compressed")
#Low <- subset.data.frame(df_data, Status.y=="CompressedWithCell"&Yasix ==100)
#MidL <- subset.data.frame(df_data, Status.y=="CompressedWithCell"&Yasix ==50)
#MidH <- subset.data.frame(df_data, Status.y=="CompressedWithCell"&Yasix ==0)
#High <- subset.data.frame(df_data, Status.y=="20%Coat")
#Low <- subset.data.frame(df_data, Status.y=="80%Coat")
MidL <- subset.data.frame(df_data, Status.y=="UnCompressedWithCell")
#MidH <- subset.data.frame(df_data, Status.y=="Uncompressed")
```

#### 1. Low

The Shapiro test indicates that the data is `r if(normal$p.value < 0.05){"NON-normal distribution."}else{"normal distribution."}`(p-value = `r {round(normal$p.value,digits=3)}`). Here are `r length(out_ind)` outlines - `r out`.

```{r normal}
normal <- shapiro.test(Low$`YoungsModulus`)
normal
simple.eda(Low$`YoungsModulus`)
out <- boxplot.stats(Low$`YoungsModulus`)$out
out_ind <- which(Low$`YoungsModulus` %in% c(out))
Low[out_ind,]
```

#### 2. Middle

The Shapiro test indicates that the data is `r if(normalMid$p.value < 0.05){"NON-normal distribution."}else{"normal distribution."}`(p-value = `r {round(normalMid$p.value,digits=3)}`). Here are `r length(out_M_ind)` outlines - `r out_M`.

```{r}
normalMid <- shapiro.test(MidL$`YoungsModulus`)
normalMid
simple.eda(MidL$`YoungsModulus`)
out_M <- boxplot.stats(MidL$`YoungsModulus`)$out
out_M_ind <- which(MidL$`YoungsModulus` %in% c(out_M))
MidH[out_M_ind,]
```

#### 3. High

The Shapiro test indicates that the data is `r if(normalTest$p.value < 0.05){"NON-normal distribution."}else{"normal distribution."}`(p-value = `r {round(normalTest$p.value,digits=3)}`). Here are `r length(out_H_ind)` outlines - `r out_H`.

```{r}
normalTest <- shapiro.test(High$`YoungsModulus`)
normalTest
simple.eda(High$`YoungsModulus`)
out_H <- boxplot.stats(High$`YoungsModulus`)$out
out_H_ind <- which(High$`YoungsModulus` %in% c(out_H))
High[out_H_ind,]
```

## Stiffness

#### 0. check distribution
```{r}
descdist(df_data$YoungsModulus, discrete = FALSE)

x_scaled <- (df_data$YoungsModulus - min(df_data$YoungsModulus) + 0.001) / (max(df_data$YoungsModulus) - min(df_data$YoungsModulus) + 0.002)
plot(fitdist(x_scaled,"beta"))
fitdist(x_scaled,"beta")$aic
```


#### 1. Comparison

```{r}  
#colnames(df_data)[which(names(df_data)=="Experiment Sample")]<-"Sample"
#pstat <- compare_means(`YoungsModulus` ~ Status.y,data = df_data, method = "t.test")
pstat <- compare_means(`YoungsModulus` ~ allStatus,data = df_data, method = "kruskal.test")
#pstat <- compare_means(`YoungsModulus` ~ Status.y,data = df_data, method = "wilcox.test")
pstat
#pstat<- aov(YoungsModulus ~ allStatus, data=df_data)
#summary(pstat)
#TukeyHSD(pstat)
#uve <- t.test(`YoungsModulus` ~ Status.y,data = df_data)
#uve$stderr
#friedman.test(df_data$YoungsModulus,df_data$Status,df_data$culture)
```
```{r}
power.t.test(10,14.2754,2.312852,sig.level=.05, type='two.sample')
```


#### 1.5 GEE
```{r}
geerun <- geeglm(YoungsModulus ~ Status*culture, id=Sample, data=df_data, family=gaussian , corstr = "ar1")
summary(geerun)
#anova(geerun)
```



#### 2. post-hoc

```{r}
dun_all <- df_data %>%
#  group_by(culture) %>%
  dunn_test(YoungsModulus ~ allStatus, p.adjust.method="bonferroni") %>%
#  dunn_test(YoungsModulus ~ Yasix, p.adjust.method="bonferroni") %>%
#  dunn_test(YoungsModulus ~ Sample, p.adjust.method="bonferroni") %>%
#  filter(p.adj.signif != "ns") %>%
  add_xy_position(x="Status.y", group = "Status")
#  add_xy_position(x="Status.y")

dun_all

dun_all$dollarsign <- ifelse(dun_all$p.adj<=0.0001,"$$$$",
                         ifelse(dun_all$p.adj<=0.001,"$$$",
                                ifelse(dun_all$p.adj<=0.01,"$$",
                                       ifelse(dun_all$p.adj<=0.05,"$","ns"))))

dun_all$andsign <- ifelse(dun_all$p.adj<=0.0001,"&&&&",
                         ifelse(dun_all$p.adj<=0.001,"&&&",
                                ifelse(dun_all$p.adj<=0.01,"&&",
                                       ifelse(dun_all$p.adj<=0.05,"&","ns"))))
dun_all

#dun_y <- df_data %>%
#  group_by(Status) %>%
#  dunn_test(YoungsModulus ~ culture, p.adjust.method="bonferroni")%>%
#    add_xy_position(x="Status", group = "culture")

#dun_y

#dun_all <- df_data %>%
#  group_by(Status) %>%
#  dunn_test(YoungsModulus ~ Status.y, p.adjust.method="bonferroni") %>%
#  add_xy_position(group = "culture")

#dun_all
```

```{r}
dun <- df_data %>%
#  tukey_hsd(YoungsModulus ~ Status.y)
  group_by(Status) %>%
  dunn_test(YoungsModulus ~ culture, p.adjust.method="bonferroni") %>%
#  dunn_test(YoungsModulus ~ Yasix, p.adjust.method="bonferroni") %>%
#  dunn_test(YoungsModulus ~ Sample, p.adjust.method="bonferroni") %>%
#  filter(p.adj.signif != "ns") %>%
  add_xy_position(x="culture", group = "Status")
#  add_xy_position(x="Status.y", fun = "mean_se")
dun
dun$andsign <- ifelse(dun$p.adj<=0.0001,"&&&&",
                         ifelse(dun$p.adj<=0.001,"&&&",
                                ifelse(dun$p.adj<=0.01,"&&",
                                       ifelse(dun$p.adj<=0.05,"&","ns"))))
#tukey_hsd(pstat)
```

#### 3. Boxplot
```{r fig.width = 4.5,fig.height = 6}
#my_xlab <- paste(SynthesisMatrix$`Status.y`,"\n(N=",SynthesisMatrix$count,")",sep="")
#my_xlab <- paste("(N=",thickMatrix$count,")",sep="")
#df_data$Status.y <- factor(df_data$Status.y, levels = c("Uncompressed","Compressed"))
#my_xlab <- c("Day 0","Day 7","with Spheroid \n for 7 days")
my_xlab <- c("Uncompressed","Compressed")
windowsFonts(A = windowsFont("Times New Roman")) 

#tiff("stiffbox_plan.tiff",units = "in", width = 5,height = 5 , res = 1200)

stiffbox_plan <- ggboxplot(df_data,x="Status.y",y="YoungsModulus", width = 0.75, title = " ", fill = "Status.x", size = 0.6)+ 
  scale_y_continuous(expand = c(0,0), breaks = seq(0,4,0.5),limits = c(0,4))+
#  scale_x_discrete(guide = guide_axis(n.dodge = 2))+
#  scale_fill_manual(values = c("white","darkgray"))+
#  stat_pvalue_manual(dun,hide.ns = TRUE, size = 12,tip.length = 0, step.increase = 0.1)+
#    scale_x_discrete(labels=my_xlab)+
#  labs(subtitle = get_test_label(wilcox_test(YoungsModulus ~ Status.y,data = df_data), detailed = T))+
  rotate_x_text(angle = 0)+
  labs( y="Young's modulus (kPa)", fill="ECM ")+
  easy_center_title()+
  theme_bw()+
  border(size = 2)+
#  scale_fill_manual(
#    values = c("white","gray20"),
#                    name = "Collagen Construct",label=c("Day 0","Day 7","with Spheroid for 7 days"))+
#                    name = "Collagen Construct",label=c("Uncompressed","Compressed"))+
#  scale_fill_discrete(name = "Collagen Construct", label=c("before","after 7 days"))+
#  scale_fill_discrete(name = "Process", label=c("Collagen Construct","Collagen Film"))+
#  scale_fill_discrete(name="Condition")+
#  scale_shape_discrete(name="Condition")+
  theme(
#        axis.line = element_line(size = 2),
        axis.ticks = element_line(size = 1),
        axis.ticks.length=unit(0.2, "cm"),
#        prism.ticks.length.y = unit(0.12, "cm"),
        axis.text.y = element_text(size = 25, color = "black", face = "bold"),
        axis.text.x = element_text(size = 18, face = "bold", color = "black",vjust = 0.5),
        axis.title = element_text(size = 30, face = "bold"),
        axis.title.x = element_blank(),
        legend.text = element_text(size=12, face = "bold"),
        legend.title = element_text(size=12, face = "bold"),
        plot.subtitle = element_text(size = 18, face = "bold", hjust = 1),
        plot.title = element_blank(),
        text = element_text(family ="A"),
        legend.position = "right",
#        legend.position = c(0.18,0.91),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        legend.background = element_rect(fill='transparent') #transparent legend bg
#        legend.box.background = element_rect(fill='transparent')
#        legend.box = element_rect(linetype = 0)
        )
#    stat_pvalue_manual(dun,hide.ns = TRUE, size = 6, tip.length = 0, bracket.size = 1, step.increase = 0.01,family = "A")+
#  stat_pvalue_manual(dun_all,hide.ns = TRUE, size = 10, tip.length = 0, bracket.size = 1, step.increase = 0.01,family = "A",remove.bracket = TRUE)+

#  stat_summary(fun = mean, geom = "point", shape = 18, size = 3, color = "darkred",
#               position = position_dodge(width = 0.8))+
#  stat_summary(fun = mean, colour = "red", 
#               position = position_dodge(width = 0.8),
#               geom = "text", vjust = -0.7, 
#               aes(label = round(..y.., digits = 1)), size=5)+
#  coord_cartesian(clip = "off")+
#  annotation_custom(textGrob("Collagen", gp=gpar(fontsize=12, fontface="bold")),xmin=1.5,xmax=1.5,ymin=-3.2,ymax=-3.2)+
#  annotation_custom(textGrob("Spheroid \n Compressed", gp=gpar(fontsize=12, fontface="bold")),xmin=3.5,xmax=3.5,ymin=-3,ymax=-3)+
#  annotation_custom(textGrob("Spheroid \n Uncompressed", gp=gpar(fontsize=12, fontface="bold")),xmin=5.5,xmax=5.5,ymin=-3,ymax=-3)+
#    stat_pvalue_manual(dun,hide.ns = TRUE, size = 10, tip.length = 0, bracket.size = 1)+
#  labs(subtitle = get_test_label(t_test(YoungsModulus ~ Status.y,data = df_data), detailed = T))
#  ylim(c(0,45))
#  rotate_x_text(angle = 30)

stiffbox_plan
#dev.off()
```

### 3.5 Boxplot with median and mean
```{r fig.width = 4.5,fig.height = 3.5}
windowsFonts(A = windowsFont("Times New Roman")) 
my_xlab <- c("20% Collagen","80% Collagen")


paper <-ggplot(data = df_data,aes(x=`Status.y`,y=YoungsModulus))+
         geom_boxplot(aes(fill = `Status.x`), size=0.8, color="black")+
  scale_fill_manual(values = c("white","black"),name = "Coating", label=c("Pre","Post"))

dat <- ggplot_build(paper)$data[[1]]

paper + geom_segment(data=dat, aes(x=xmin, xend=xmax, 
                             y=middle, yend=middle, color=fill), size=0.5)+
    stat_summary(aes(group =`Status.x`),geom = "errorbar", width = 0.65,fun.min = mean, fun = mean, fun.max = mean,position = position_dodge(0.75), linetype = "dashed", color=c("black","black","white","white"))+
    scale_color_manual(values = c("white","black"),name = "Coating", label=c("Pre","Post"))+
  scale_y_continuous(expand = c(0,0),limits = c(0,3.5),name = "Young's Modulus (kPa)")+
#   stat_pvalue_manual(thi,hide.ns = TRUE, size = 5, tip.length = 0, bracket.size = 1, step.increase = 0.01,label = "{dollarsign}",family = "A")+
#  stat_pvalue_manual(thic,hide.ns = TRUE, size = 10, tip.length = 0, bracket.size = 1, step.increase = 0.01, remove.bracket = TRUE,y.position = 40,family = "A")+
  scale_x_discrete(labels=my_xlab)+
  theme_bw()+
  border(size = 2)+
  easy_center_title()+  
  theme(axis.ticks.length=unit(0.2, "cm"),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.text.x = element_text(size = 15, color = "black", face = "bold",vjust = 0.5),
        axis.text.y = element_text(size = 20, color = "black", face = "bold"),
        axis.title.y = element_text(size = 20, face = "bold"),
        legend.text = element_text(size=15, face = "bold"),
        legend.title = element_text(size=15,face = "bold"),
        plot.subtitle = element_text(size = 20, face = "bold",hjust = 0.5),
        plot.title = element_blank(),
        text = element_text(family ="A"),
        legend.position = "top",
        axis.ticks = element_line(size = 1, colour = "black"),
        axis.title.x = element_blank(),
        axis.ticks.length.x.top = unit(0,"cm"),
        axis.text.y.right = element_blank(),
        axis.ticks.length.y.right = unit(0,"cm")
        )


```

##### Save the boxplot for paper
```{r}
ggsave("stiffbox_plan.tiff",device = 'tiff',dpi = 700)
```


### Dark boxplot
```{r fig.width = 4.5,fig.height = 6}
#my_xlab <- paste(SynthesisMatrix$`Status.y`,"\n(N=",SynthesisMatrix$count,")",sep="")
#my_xlab <- paste("(N=",thickMatrix$count,")",sep="")

ggboxplot(df_data,x="Status.y",y="YoungsModulus", width = 0.75, title = " ", fill = "Status.x", color = "white",size = 1)+ 
  scale_y_continuous(expand = c(0,0.1), limits = c(0,2))+
#  scale_x_discrete(guide = guide_axis(n.dodge = 2))+
#  scale_fill_manual(values = c("#00BFC4","#EE6363"))+
#    scale_x_discrete(labels=my_xlab)+
#  labs(subtitle = get_test_label(wilcox_test(YoungsModulus ~ Status.y,data = df_data), detailed = T))+
  rotate_x_text(angle = 0)+
  theme_bw()+
  border(size = 3, color = "white")+
  labs( y="Young's modulus (kPa)", fill="ECM", title = "Stiffness")+
  easy_center_title()+
#  scale_fill_discrete(name="Condition")+
#  scale_shape_discrete(name="Condition")+
  theme(
#        axis.line = element_line(colour = "white",size = 3),
        axis.ticks = element_line(colour ="white",size = 1),
        axis.ticks.length=unit(0.6, "cm"),
#        prism.ticks.length.y = unit(0.12, "cm"),
        axis.text.x = element_text(size = 20, color = "white", face = "bold"),
        axis.text.y = element_text(size = 20, color = "white", face = "bold"),
        axis.title = element_text(size = 20, face = "bold",colour = "white"),
        axis.title.x = element_blank(),
        legend.text = element_text(colour = 'white',size=45, face = "bold"),
        legend.title = element_text(colour = 'white',size=45,face = "bold"),
        plot.subtitle = element_text(colour = "white", size = 16, face = "bold"),
#        plot.title = element_blank(),
        plot.title = element_text(colour = "white",size=60, face = "bold"),
        text = element_text(family ="A"),
        legend.position = "none",
        panel.background = element_rect(fill = 'black'),
        plot.background=element_rect(fill = "black",colour = "black"),
        legend.background = element_rect(fill = 'black'),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        legend.key = element_rect(fill = "black")
        )
#    stat_pvalue_manual(dun,hide.ns = TRUE, size = 20, tip.length = 0, bracket.size = 1, step.increase = 0.01,remove.bracket = TRUE, color = "white")
#  stat_pvalue_manual(dun_all[2,],hide.ns = TRUE, size = 18, tip.length = 0, bracket.size = 1, step.increase = 0.01, y.position = 41, remove.bracket = TRUE, color = "white")
#    stat_pvalue_manual(dun,hide.ns = TRUE, size = 15, color = "white")+
#  labs(subtitle = get_test_label(anova_test(YoungsModulus ~ allStatus,data = df_data), detailed = T))
```


```{r fig.width = 5,fig.height = 6.2}
my_xlab <- paste(SynthesisMatrix$`Yasix`,"\n(N=",SynthesisMatrix$count,")",sep="")
#my_xlab <- paste("(N=",thickMatrix$count,")",sep="")

stiffbox <- ggboxplot(df_data,x="Yasix",y="YoungsModulus", fill = "Status.y", shape= "Status.y", width = 0.9, title = "Stiffness")+ 
  scale_y_continuous(expand = c(0,0))+
#  stat_pvalue_manual(dun,hide.ns = TRUE, size = 10,tip.length = 0, step.increase = 0.1)+
    scale_x_discrete(labels=my_xlab)+
#  labs(subtitle = get_test_label(kruskal_test(YoungsModulus ~ allStatus,data = df_data), detailed = T))+
  rotate_x_text(angle = 0)+
  labs( y="Youngs Modulus (kPa)", x=" ")+
  easy_center_title()+
  scale_fill_discrete(name="Condition")+
  scale_shape_discrete(name="Condition")+
  theme(axis.line = element_line(size = 2),
        axis.ticks = element_line(size = 2),
        axis.ticks.length=unit(0.2, "cm"),
#        prism.ticks.length.y = unit(0.12, "cm"),
        axis.text = element_text(size = 12, color = "black", face = "bold"),
        axis.title = element_text(size = 20, face = "bold"),
        legend.text = element_text(size=19, face = "bold"),
        legend.title = element_text(size=19,face = "bold"),
        plot.subtitle = element_text(size = 16, face = "bold",hjust = 0.5),
        plot.title = element_text(size=28, face = "bold"))+
  stat_summary(fun = mean, geom = "point", shape = 18, size = 3, color = "darkred",
               position = position_dodge(width = 0.8))+
  stat_summary(fun = mean, colour = "red", 
               position = position_dodge(width = 0.8),
               geom = "text", vjust = -0.7, 
               aes(label = round(..y.., digits = 1)), size=5)+
  coord_cartesian(clip = "off")+
  annotation_custom(textGrob("Collagen", gp=gpar(fontsize=12, fontface="bold")),xmin=1.5,xmax=1.5,ymin=-3.2,ymax=-3.2)+
  annotation_custom(textGrob("Spheroid \n Compressed", gp=gpar(fontsize=12, fontface="bold")),xmin=3.5,xmax=3.5,ymin=-3,ymax=-3)+
  annotation_custom(textGrob("Spheroid \n Uncompressed", gp=gpar(fontsize=12, fontface="bold")),xmin=5.5,xmax=5.5,ymin=-3,ymax=-3)+
    stat_pvalue_manual(dun,hide.ns = TRUE, size = 7)+
  labs(subtitle = get_test_label(kruskal_test(YoungsModulus ~ Yasix,data = df_data), detailed = T))

stiffbox

```



```{r fig.width = 10,fig.height = 10}
# prepare a special xlab with the number of obs for each group
my_xlab <- paste(SynthesisMatrix$`allStatus`,"\n(N=",SynthesisMatrix$count,")",sep="")
par(pin=c(8,20))
#plot
ggbarplot(df_data,x="Yasix",y="YoungsModulus",add = "mean_se", ylab = "Youngs Modulus (kPa)",label = TRUE, fill = "Status.x", lab.nb.digits = 2,
                    lab.vjust=1.5,
          lab.pos = "in", lab.col = "black", lab.size = 5, error.plot = "upper_errorbar", title = "The stiffness of the flat collagen \n 1 week spheroid",position = position_dodge(0.7),ylim=c(0,50),)+
  easy_center_title()+
  theme(text = element_text(size=10),
        plot.title = element_text(size=20))+ 
  scale_y_continuous(expand = c(0,0))+
    scale_x_discrete(labels=my_xlab, limits=SynthesisMatrix$allStatus)+
    stat_pvalue_manual(dun,hide.ns = TRUE, size = 7)+
  labs(subtitle = get_test_label(kruskal_test(YoungsModulus ~ allStatus,data = df_data), detailed = T))+
  rotate_x_text(angle = 45)
```

#### 4. Dark boxplot

```{r fig.width = 10,fig.height = 10}
ggbarplot(df_data,x="Centrifuge.RPM",y="YoungsModulus",add = "mean_se", ylab = "Youngs Modulus (kPa)",label = TRUE, 
          fill = "Status.y", 
          lab.nb.digits = 2,
          lab.vjust=1.5,
          lab.pos = "in", lab.col = "white", lab.size = 8, size = 2, error.plot = "upper_errorbar", color = "white", add.params = list(size = 2),position = position_dodge(0.7),
#          ylim=c(0,50)
          )+
  easy_center_title()+
  scale_y_continuous(expand = c(0,0))+
  theme(text = element_text(size=28),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_rect(fill = 'black'),
        plot.background=element_rect(fill = "black",colour = "black"),
        axis.line = element_line(colour = "white", size = 1),
        axis.title = element_text(colour = "white"),
        axis.text = element_text(color = "white"),
        axis.ticks = element_line(colour ="white", size = 2),
        plot.subtitle = element_text(colour = "white"),
        legend.background = element_rect(fill = 'black'),
        legend.text = element_text(colour = 'white'))+
#    scale_x_discrete(labels=my_xlab, limits=SynthesisMatrix$`allStatus`)+
    stat_pvalue_manual(dun,hide.ns = TRUE, size = 10, color = "white")+
  labs(subtitle = get_test_label(kruskal_test(`YoungsModulus` ~ Sample,data = df_data), detailed = T))+
  rotate_x_text(angle = 45)
#label = "p = {scales::pvalue(p.adj)}",
```

#### 5. line plot
```{r }
my_xlab <- paste(SynthesisMatrix$`Yasix`,"\n(N=",SynthesisMatrix$count,")",sep="")
#my_xlab <- paste("(N=",thickMatrix$count,")",sep="")
windowsFonts(A = windowsFont("Times New Roman")) 

stiffbox <- ggplot(SynthesisMatrix,aes(x=Yasix, y=mean, color=Status.y, shape=Status.y))+
#  geom_point(size=1.5)+
  geom_point(mapping = aes(x = Yasix, y = mean), data = SynthesisMatrix, size=4)+
  geom_line(mapping = aes(x = Yasix, y = mean, color=Status.y, shape=Status.y), data = SynthesisMatrix, size=1)+
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=18)+
  theme_classic()+
  labs( y="Young's modulus (kPa)", x="Distance from the edge of A549 spheroid (mm)"
#        title = " "
        )+
  scale_color_discrete(name = "ECM ", labels=c("Compressed","Uncompressed"))+
  theme_bw()+
  border(size = 2)+
  scale_shape_discrete(name = "ECM ", labels=c("Compressed","Uncompressed"))+
  easy_center_title()+
#  annotation_custom(textGrob(paste("Cell is ", nlevels(factor(df_data$Cell))), gp=gpar(fontsize=12, fontface="bold")))+
#  scale_y_continuous(guide = "prism_minor",minor_breaks = seq(200, 1800, 100),limits = c(200,1950),expand = c(0,0))+
  scale_y_continuous(expand = c(0,0)
                     , breaks = seq(0,16,2)
                     )+
  scale_x_continuous(breaks = seq(0,250,50))+
  theme(axis.ticks = element_line(size = 2),
        axis.ticks.length=unit(0.4, "cm"),
#        prism.ticks.length.y = unit(0.2, "cm"),
        axis.text = element_text(size = 25, face = "bold", color = "black"),
        axis.title.x = element_text(size = 12, face = "bold", hjust = 1),
        axis.title.y = element_text(size=20, face = "bold", hjust = 1),
#        text = element_text(family ="A"),
        legend.position = "top",
        legend.text = element_text(size=18, face = "bold"),
        legend.title = element_text(size=18, face = "bold"),
#        plot.subtitle = element_text(size = 16, face = "bold",hjust = 0.5,colour = "white"),
        plot.title = element_text(size=30, face = "bold"),
        text = element_text(family ="A")
#        axis.title.x.bottom = element_blank()
        )+
  theme(text = element_text(size=12),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
#        panel.background = element_rect(fill = 'black'),
#        plot.background=element_rect(fill = "black",colour = "black"),
#        axis.line = element_line(colour = "black", size = 2),
#        axis.title = element_text(colour = "white"),
#        axis.text = element_text(color = "white"),
        axis.ticks = element_line(colour ="black", size = 2),
#        plot.subtitle = element_text(colour = "white"),
#        legend.background = element_rect(fill = 'black'),
#        legend.text = element_text(colour = 'white'),
#        legend.title = element_text(colour = "white"),
#        plot.title = element_text(colour = "white")
#        legend.position = "top"
  )
#  labs(subtitle = get_test_label(kruskal_test(YoungsModulus ~ Yasix,data = df_data), detailed = T))
#  stat_summary(fun = mean, colour = "red", 
#               position = position_dodge(width = 0.8),
#               geom = "text", vjust = -2.5, 
#               aes(label = round(..y.., digits = 1)), size=5)
stiffbox
```

#### 6. Dark Lineplot
```{r fig.width = 8,fig.height = 5}
my_xlab <- paste(SynthesisMatrix$`Yasix`,"\n(N=",SynthesisMatrix$count,")",sep="")
#my_xlab <- paste("(N=",thickMatrix$count,")",sep="")
windowsFonts(A = windowsFont("Times New Roman")) 

ggplot(SynthesisMatrix,aes(x=Yasix, y=mean, color=Status.y, shape=Status.y))+
#  geom_point(size=1.5)+
  geom_point(mapping = aes(x = Yasix, y = mean), data = SynthesisMatrix, size=7)+
  geom_line(mapping = aes(x = Yasix, y = mean,group=Status.y), data = SynthesisMatrix, size=2)+
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=18,size=2)+
  theme_classic()+
  labs( y="Young's modulus (kPa)", x="Distance from the edge of A549 spheroid (mm)",
#        title = " "
        )+
  scale_color_discrete(name = "ECM ", labels=c("Compressed","Uncompressed"))+
  scale_shape_discrete(name = "ECM ", labels=c("Compressed","Uncompressed"))+
  easy_center_title()+
    theme_bw()+
  border(size = 2, color = "white")+
#  annotation_custom(textGrob(paste("Cell is ", nlevels(factor(df_data$Cell))), gp=gpar(fontsize=12, fontface="bold")))+
#  scale_y_continuous(guide = "prism_minor",minor_breaks = seq(200, 1800, 100),limits = c(200,1950),expand = c(0,0))+
  scale_y_continuous(expand = c(0,0), breaks = seq(0,16,2), limits = c(0,12))+
  scale_x_continuous(breaks = seq(0,250,50))+
  theme(axis.line = element_line(size = 2),
        axis.ticks = element_line(size = 2),
        axis.ticks.length=unit(0.4, "cm"),
#        prism.ticks.length.y = unit(0.2, "cm"),
        axis.text = element_text(size = 25, face = "bold"),
        axis.title.x = element_text(size = 20, face = "bold", hjust = 1),
        axis.title.y = element_text(size=25, face = "bold", hjust = 1),
#        text = element_text(family ="A"),
        legend.position = "right",
        legend.text = element_text(size=25, face = "bold"),
        legend.title = element_text(size=25, face = "bold"),
#        plot.subtitle = element_text(size = 16, face = "bold",hjust = 0.5,colour = "white"),
        plot.title = element_text(size=30, face = "bold"),
        text = element_text(family ="A")
#        axis.title.x.bottom = element_blank()
        )+
  theme(text = element_text(size=12),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_rect(fill = 'black'),
        plot.background=element_rect(fill = "black",colour = "black"),
        axis.line = element_line(colour = "white", size = 1),
        axis.title = element_text(colour = "white"),
        axis.text = element_text(color = "white"),
        axis.ticks = element_line(colour ="white", size = 2),
        plot.subtitle = element_text(colour = "white"),
        legend.background = element_rect(fill = 'black'),
        legend.text = element_text(colour = 'white'),
        legend.title = element_text(colour = "white"),
        plot.title = element_text(colour = "white"),
        legend.position = "top",
        legend.key = element_rect(fill = "black")
#        legend.position = "none"
  )
```

#### 7. table of sample size
```{r}
ggtexttable(table(df_data$Status.y,df_data$cultureday), theme = ttheme("light",base_size = 22))
```


## Thickness

#### 1. Normality

```{r}
normalTest <- shapiro.test(Low$`Thickness`)
simple.eda(Low$`Thickness`)
normalTest
```

```{r}
normalTest <- shapiro.test(MidH$`Thickness`)
simple.eda(MidH$`Thickness`)
normalTest
```

```{r}
normalTest <- shapiro.test(MidL$`Thickness`)
simple.eda(MidL$`Thickness`)
normalTest
```


```{r}
normalTest <- shapiro.test(High$`Thickness`)
simple.eda(High$`Thickness`)
normalTest
```

 #### 2. thickness comparison

```{r}
#pstat <- compare_means(`Thickness` ~ Yasix,data = df_data, method = "kruskal.test")
pstat <- compare_means(`Thickness` ~ allStatus,data = df_data, method = "kruskal.test")
#pstat <- aov(`Thickness` ~ Status.y, data=df_data)
pstat
#summary(pstat)
```

#### 3. Post-hoc for thickness comparison

```{r}
#thi <- df_data %>%
#  tukey_hsd(Thickness ~ Status.y)  %>%
#  add_xy_position(x="Status.y", fun = "mean_se", dodge = 0.2) 
#thi
thi <- df_data %>%
  group_by(Ingredient) %>%
  dunn_test(Thickness ~ Status.y, p.adjust.method="bonferroni")%>%
  add_xy_position(x="Status.y", fun = "max", dodge = 0.7, group = "Ingredient", 
                  step.increase = 0.05
                  )
thi$dollarsign <- ifelse(thi$p.adj<=0.0001,"$$$$",
                         ifelse(thi$p.adj<=0.001,"$$$",
                                ifelse(thi$p.adj<=0.01,"$$",
                                       ifelse(thi$p.adj<=0.05,"$","ns"))))

thi$andsign <- ifelse(thi$p.adj<=0.0001,"&&&&",
                         ifelse(thi$p.adj<=0.001,"&&&",
                                ifelse(thi$p.adj<=0.01,"&&",
                                       ifelse(thi$p.adj<=0.05,"&","ns"))))

thi

thic <- df_data %>%
  group_by(Status.y) %>%
  dunn_test(Thickness ~ Ingredient, p.adjust.method="bonferroni")%>%
  add_xy_position(x="Status.y", fun = "max", dodge = 0.7, group = "Ingredient", 
                  step.increase = 0.05
                  )
thic
#tukey_hsd(pstat)
```
#### 3.1 GEE
```{r}
geerunThic <- geeglm(Thickness ~ factor(Yasix)+Status.y+factor(Yasix)*Status.y, id=Sample, data=df_data, family=gaussian , corstr = "ar1")
summary(geerunThic)
```



#### 4. Boxplot
```{r}
thickbox <- ggboxplot(df_data,x="Yasix",y="Thickness", title = "Thickness", width = 0.9, color = "Status.y")+
#  ylim(c(470,3775))+ 
#  scale_y_continuous(expand = c(0,0))+
  stat_pvalue_manual(thi,hide.ns = TRUE, size = 10)+
#    scale_x_discrete(labels=my_xlab, limits=c(0,100,150,200))+
#  labs(subtitle = get_test_label(kruskal_test(Thickness ~ allStatus,data = df_data), detailed = T))+
#  rotate_x_text(angle = 30)+
  labs( y="Thicknesss (μm)", x=" ")+
  easy_center_title()+
#  scale_fill_discrete(name="Condition")+
#  scale_shape_discrete(name="Condition")+
#  scale_y_break(c(620,3700),scales = 1)+
  theme(axis.line = element_line(size = 2,colour = "white"),
        axis.ticks = element_line(size = 2,colour ="white"),
        axis.ticks.length=unit(0.4, "cm"),
#        prism.ticks.length.y = unit(0.12, "cm"),
        axis.text = element_text(size = 20, color = "white", face = "bold"),
        axis.title = element_text(size = 20, face = "bold",colour = "white"),
        legend.position = "none",
#        legend.text = element_text(size=19, face = "bold"),
#        legend.title = element_text(size=19,face = "bold"),
        plot.subtitle = element_text(size = 16, face = "bold",hjust = 0.5,colour = "white"),
        plot.title = element_text(size=28, face = "bold",colour = "white"),
#        axis.text.y.right = element_blank(),
#        axis.line.y.right = element_blank(),
#        axis.ticks.y.right = element_blank(),
        text = element_text(size=12),
#        panel.grid.major = element_blank(),
#        panel.grid.minor = element_blank(),
        panel.background = element_rect(fill = 'black'),
        plot.background=element_rect(fill = "black", colour = "black"),
#        axis.text = element_text(color = "white"),
        legend.background = element_rect(fill = 'black'),
        legend.text = element_text(colour = 'white'),
        legend.title = element_text(colour = "white"),
        rect = element_rect(fill="black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())+
  labs(subtitle = get_test_label(kruskal_test(`Thickness` ~ Status.y,data = df_data), detailed = T))
#  stat_summary(fun = mean, geom = "point", shape = 18, size = 3, color = "darkred",
#               position = position_dodge(width = 0.8))+
#  stat_summary(fun = mean, colour = "red", 
#               position = position_dodge(width = 0.8),
#               geom = "text", vjust = -0.7, 
#               aes(label = round(..y.., digits = 1)), size=5)

thickbox
```

#### 4.5 Paper like Thick boxplot
```{r fig.width = 4.5,fig.height = 2.5}
# fig.height=10, fig.width=7
windowsFonts(A = windowsFont("Times New Roman")) 
#my_xlab <- c("Uncompressed","Compressed","20% Collagen", "80% Collagen")
my_xlab <- c("20% Collagen","80% Collagen")



paperthic <- ggboxplot(df_data,x="Status.y",y="Thickness", title = "Thickness",  fill = "Ingredient", ylab = "Thickness (μm)")+
#  scale_x_continuous(sec.axis = dup_axis())+
  scale_y_continuous(limits = c(0,150))+
#  scale_y_break(c(650,3000),scales = 1,ticklabels = c(3000,3500,4000), expand = FALSE)+
#  scale_y_break(c(40,300),scales = 1,ticklabels = c(0,20,40,300,350,400))+
  stat_pvalue_manual(thi,hide.ns = TRUE, size = 5, tip.length = 0, bracket.size = 1, step.increase = 0.01,label = "{dollarsign}",family = "A")+
  stat_pvalue_manual(thic,hide.ns = TRUE, size = 10, tip.length = 0, bracket.size = 1, step.increase = 0.01, remove.bracket = TRUE,y.position = 40,family = "A")+
#  stat_pvalue_manual(thi[4:5,],hide.ns = TRUE, size = 5, tip.length = 0, bracket.size = 1, step.increase = 0.01, remove.bracket = TRUE,label = "{andsign}", y.position = 30)+
  scale_fill_discrete(name = "Matrix Type", label=c("Polyacrylamide","Glass"))+
    scale_fill_manual(
    values = c("white","black"),
                    name = "Collagen Construct",label=c("Day 0","Day 7","with Spheroid for 7 days"))+
#                    name = "Collagen Concentration",label=c("20%","80%"))+
  scale_x_discrete(labels=my_xlab
#                   ,guide = guide_axis(n.dodge = 2)
                   )+
  theme_bw()+
#  theme_classic()+
  border(size = 2)+
  easy_center_title()+  
  theme(axis.ticks.length=unit(0.2, "cm"),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
#        prism.ticks.length.y = unit(0.12, "cm"),
        axis.text.x = element_text(size = 15, color = "black", face = "bold",vjust = 0.5),
        axis.text.y = element_text(size = 20, color = "black", face = "bold"),
        axis.title.y = element_text(size = 20, face = "bold"),
#        axis.title.x = element_text(size = 18, face = "bold"),
        legend.text = element_text(size=20, face = "bold"),
        legend.title = element_text(size=20,face = "bold"),
        plot.subtitle = element_text(size = 20, face = "bold",hjust = 0.5),
        plot.title = element_blank(),
#        axis.line = element_line(size = 1.3),
        text = element_text(family ="A"),
        legend.position = "none",
#        legend.position = c(0.16,0.85),
        axis.ticks = element_line(size = 1, colour = "black"),
        axis.title.x = element_blank(),
        axis.ticks.length.x.top = unit(0,"cm"),
#        axis.line.x.top = element_line(size = 50),
#        strip.background = element_blank(),
#        panel.border = element_blank(),
#        panel.background = element_blank(),
#        axis.line = element_line(size = 1.5),
        axis.text.y.right = element_blank(),
        axis.ticks.length.y.right = unit(0,"cm")
        )

paperthic
#  labs(tag = "~") +
#theme(plot.tag.position = c(0.15, 0.37),plot.tag=element_text(size = 1))

#tiff("paperthic.tiff",units = "in", width = 7,height = 6 , res = 1200)
#finalthic <- print(paperthic)+theme(plot.margin = margin(t = 0,  # Top margin
#                             r = 0,  # Right margin
#                             b = 0,  # Bottom margin
#                             l = 0) # Left margin
#                       )
#finalthic
#ev.off()
```
```{r}
ggsave("print(paperthic)", device = "tiff", dpi = 700)
```

### 4.6 Boxplot with median and mean
```{r fig.width = 4.5,fig.height = 2.5}
windowsFonts(A = windowsFont("Times New Roman")) 
my_xlab <- c("20% Collagen","80% Collagen")


paper <-ggplot(data = df_data,aes(x=`Status.y`,y=Thickness))+
         geom_boxplot(aes(group =interaction(`Status.y`,Ingredient),fill = Ingredient), size=0.8, color="black")+
  scale_fill_manual(values = c("white","black"),name = "Matrix Type", label=c("Polyacrylamide","Glass"))

dat <- ggplot_build(paper)$data[[1]]

paper + geom_segment(data=dat, aes(x=xmin, xend=xmax, 
                             y=middle, yend=middle, color=fill), size=1)+
    stat_summary(aes(group =interaction(Ingredient,`Status.y`)),geom = "errorbar", width = 0.65,fun.min = mean, fun = mean, fun.max = mean,position = position_dodge(0.75), linetype = "dashed", color=c("black","black","black","white"))+
    scale_color_manual(values = c("white","black"))+
  scale_y_continuous(limits = c(0,150),name = "Thickness (μm)")+
   stat_pvalue_manual(thi,hide.ns = TRUE, size = 5, tip.length = 0, bracket.size = 1, step.increase = 0.01,label = "{dollarsign}",family = "A")+
  stat_pvalue_manual(thic,hide.ns = TRUE, size = 10, tip.length = 0, bracket.size = 1, step.increase = 0.01, remove.bracket = TRUE,y.position = 40,family = "A")+
  scale_x_discrete(labels=my_xlab)+
  theme_bw()+
  border(size = 2)+
  easy_center_title()+  
  theme(axis.ticks.length=unit(0.2, "cm"),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.text.x = element_text(size = 15, color = "black", face = "bold",vjust = 0.5),
        axis.text.y = element_text(size = 20, color = "black", face = "bold"),
        axis.title.y = element_text(size = 20, face = "bold"),
        legend.text = element_text(size=20, face = "bold"),
        legend.title = element_text(size=20,face = "bold"),
        plot.subtitle = element_text(size = 20, face = "bold",hjust = 0.5),
        plot.title = element_blank(),
        text = element_text(family ="A"),
        legend.position = "none",
        axis.ticks = element_line(size = 1, colour = "black"),
        axis.title.x = element_blank(),
        axis.ticks.length.x.top = unit(0,"cm"),
        axis.text.y.right = element_blank(),
        axis.ticks.length.y.right = unit(0,"cm")
        )


```



```{r,fig.asp=1}
#my_xlab <- paste(thickMatrix$Yasix,"\n(N=",thickMatrix$count,")",sep="")
#my_xlab <- paste("(N=",thickMatrix$count,")",sep="")

thickbox <- ggboxplot(df_data,x="Status.y",y="Thickness", fill = "Ingredient", shape= "Ingredient", title = "Thickness", width = 0.9, color = "white")+
#  ylim(c(470,3775))+ 
#  scale_y_continuous(expand = c(0,0))+
#  stat_pvalue_manual(thi,hide.ns = TRUE, size = 10)+
#    scale_x_discrete(labels=my_xlab, limits=c(0,100,150,200))+
#  labs(subtitle = get_test_label(kruskal_test(Thickness ~ allStatus,data = df_data), detailed = T))+
#  rotate_x_text(angle = 30)+
  labs( y="Thicknesss (μm)", x=" ")+
  easy_center_title()+
#  scale_fill_discrete(name="Condition")+
#  scale_shape_discrete(name="Condition")+
#  scale_y_break(c(620,3700),scales = 1)+
  theme(axis.line = element_line(size = 2,colour = "white"),
        axis.ticks = element_line(size = 2,colour ="white"),
        axis.ticks.length=unit(0.4, "cm"),
        prism.ticks.length.y = unit(0.12, "cm"),
        axis.text = element_text(size = 20, color = "white", face = "bold"),
        axis.title = element_text(size = 20, face = "bold",colour = "white"),
        legend.position = "none",
#        legend.text = element_text(size=19, face = "bold"),
#        legend.title = element_text(size=19,face = "bold"),
        plot.subtitle = element_text(size = 16, face = "bold",hjust = 0.5,colour = "white"),
        plot.title = element_text(size=28, face = "bold",colour = "white"),
#        axis.text.y.right = element_blank(),
#        axis.line.y.right = element_blank(),
#        axis.ticks.y.right = element_blank(),
        text = element_text(size=12),
#        panel.grid.major = element_blank(),
#        panel.grid.minor = element_blank(),
        panel.background = element_rect(fill = 'black'),
        plot.background=element_rect(fill = "black", colour = "black"),
#        axis.text = element_text(color = "white"),
        legend.background = element_rect(fill = 'black'),
        legend.text = element_text(colour = 'white'),
        legend.title = element_text(colour = "white"),
        rect = element_rect(fill="black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())+
  labs(subtitle = get_test_label(kruskal_test(`Thickness` ~ Yasix,data = df_data), detailed = T))+
  stat_summary(fun = mean, geom = "point", shape = 18, size = 3, color = "darkred",
               position = position_dodge(width = 0.8))+
  stat_summary(fun = mean, colour = "red", 
               position = position_dodge(width = 0.8),
               geom = "text", vjust = -0.7, 
               aes(label = round(..y.., digits = 1)), size=5)
#  stat_summary(fun = mean, geom = "point", shape = 18, size = 3, color = "darkred",
#               position = position_dodge(width = 0.8))+
#  stat_summary(fun = mean, colour = "red", 
#               position = position_dodge(width = 0.8),
#               geom = "text", vjust = -0.5, 
#               aes(label = round(..y.., digits = 1)), size=5)+
#  coord_cartesian(clip = "off")+
#  annotation_custom(textGrob("Collagen", gp=gpar(fontsize=12, fontface="bold")),xmin=1.5,xmax=1.5,ymin=-90,ymax=-90)+
#  annotation_custom(textGrob("Spheroid \n Compressed", gp=gpar(fontsize=12, fontface="bold")),xmin=3.5,xmax=3.5,ymin=250,ymax=250)+
#  annotation_custom(textGrob("Spheroid \n Uncompressed", gp=gpar(fontsize=12, fontface="bold")),xmin=5.5,xmax=5.5,ymin=-70,ymax=-70)+
#    stat_pvalue_manual(thi,hide.ns = TRUE, size = 7)
#  labs(subtitle = get_test_label(kruskal_test(`Thickness` ~ Yasix,data = df_data), detailed = T))
#  geom_hline(yintercept = 620,linetype="longdash", color="white")+
#  geom_hline(yintercept = 3700, linetype="longdash", color="white")


#truThickbox <- print(thickbox)+ 
#  theme(plot.background = element_rect(fill = 'black', color = 'black'),
#        panel.background = element_rect(fill = 'black', color = 'black'),
#        panel.border = element_rect(color = 'black', linewidth = 6, fill = NA),
#        axis.line = element_line(color = 'black', linewidth = 2))

#truThickbox
thickbox
```

### joined paper

```{r}
# prepare a special xlab with the number of obs for each group
#my_xlab <- paste(str_sub(SynthesisMatrix$Area,2,-1),"\n(N=",SynthesisMatrix$thickCount,")",sep="")
#my_xlab <- paste(thickMatrix$Status.y,"\n(N=",thickMatrix$count,")",sep="")
#plot
windowsFonts(A = windowsFont("Times New Roman"))

#df_data$Status.y <- factor(df_data$Status.y, levels = c("20%Coat","80%Coat","Compressed","Uncompressed"))

test <- ggbarplot(df_data,x= "Yasix" ,y="Thickness",add = "mean_se", ylab = "Thicknesss (μm)", fill = "Status.y", color = "Status.y",label = FALSE, lab.nb.digits = 2, size = 1,add.params = list(size = 1),
#          lab.vjust=1.5,
#          position = position_dodge(0.7),  width = 30,
#          lab.pos = "out", lab.col = "black", lab.size = 6 , 
  error.plot = "upper_errorbar", title = "Thickness")+
#  scale_fill_manual(values = c("white","darkgray"))+
    easy_center_title()+
    labs( y="Thicknesss (μm)")+
#    theme_bw()+
#    border(size = 2)+
#  theme(text = element_text(size=12))+ 
#    scale_x_discrete(breaks="Yasix")+
#    stat_pvalue_manual(thi,hide.ns = TRUE, size = 6,tip.length = 0, bracket.size = 1, step.increase = 0.01)+
#  labs(x=" ", subtitle = get_test_label(kruskal_test(`Thickness` ~ Status.y,data = df_data), detailed = T))+
#  rotate_x_text(angle = 45)+
  theme(text = element_text(family ="A"),
        axis.line = element_line(size = 1.3),
        axis.line.x.top = element_line(size=1),
        axis.ticks = element_line(size = 1),
        axis.ticks.length=unit(0.2, "cm"),
#        prism.ticks.length.y = unit(0.12, "cm"),
        axis.text.x = element_text(size = 12, color = "black", face = "bold"),
        axis.text.y = element_text(size = 10, color = "black", face = "bold"),
        axis.title = element_text(size = 14, color = "black", face = "bold"),
        legend.text = element_text(size=19, face = "bold"),
        legend.title = element_text(size=19,face = "bold"),
        plot.subtitle = element_text(size = 20, face = "bold",hjust = 0.5),
        plot.title = element_blank(),
        axis.line.y.right = element_blank(),
        axis.text.y.right = element_blank(),
        axis.ticks.y.right = element_blank() ,
        legend.position = "none",
        axis.title.x = element_blank(),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        plot.margin = unit(c(0,0,0,0),"cm"))
#    scale_x_discrete(labels=my_xlab)+
#    scale_y_continuous(expand = c(0,0), limits = c(0,8000), breaks = c(0,20))+
#    scale_y_break(c(350,3500),scales = 2.2,space = 0.3, ticklabels = c(3500,5000,6500),expand = FALSE)+
#    scale_y_break(c(20,330),scales = 1.1,space = 0.3, ticklabels = c(0,15,20,330,340,350),expand = FALSE)+
#  geom_hline(yintercept = 7980, size=1.5)+
#  geom_vline(xintercept = 4.588, size=1.3)

#test$labels$y.position <- NULL
test
#    border(size = 2)
```

#### 5. Dark boxplot
```{r }
thickbox <- ggbarplot(df_data,x="Yasix",y="Thickness",add = "mean_se", ylab = "Thickness (μm)", label = FALSE,
#          fill = "black", 
#          lab.nb.digits = 2,lab.pos = "in", lab.col = "white", error.plot = "errorbar", color = "white", 
#          lab.size = 5, size=2, 
          position = position_dodge(50), width = 40, 
          title = "Thickness", fill = "Status.y")+
  easy_center_title()+ 
  scale_y_continuous(expand = c(0,0), breaks = c(0,150,300, 450,600,3700,3725,3750))+
  scale_y_break(c(600,3700), scales = 0.5, expand = FALSE, space = 0.5)+
#  scale_x_continuous(breaks = seq(0,250,50))+
  theme(text = element_text(size=10),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text = element_text(size = 25, face = "bold"),
        axis.title = element_text(size = 25, face = "bold"),
        legend.position = "none",
        axis.line = element_line(size = 2),
        axis.ticks = element_line(size = 2),
        axis.ticks.length=unit(0.2, "cm"),
        axis.line.y.right = element_blank(),
        axis.text.y.right = element_blank(),
        axis.ticks.y.right = element_blank(),
        plot.title = element_text(size=25, face = "bold"),
        axis.title.x.bottom = element_blank())+
#        panel.background = element_rect(fill = 'black'),
#        plot.background=element_rect(fill = "black",colour = "black"),
#        axis.line = element_line(colour = "white", size = 1),
#        axis.title = element_text(colour = "white"),
#        axis.text = element_text(color = "white"),
#        axis.ticks = element_line(colour ="white", size = 2),
#        plot.subtitle = element_text(colour = "white"),
 #       legend.background = element_rect(fill = 'black'),
#        legend.text = element_text(colour = 'white') )+
    scale_x_discrete(limits=thickMatrix$Yasix)+
  geom_hline(yintercept=600, size=2, linetype="dashed")+
  geom_hline(yintercept=3700, size=2, linetype="dashed")
#    stat_pvalue_manual(thi,hide.ns = TRUE, size = 10, color = "white"
#        )
#  labs(subtitle = get_test_label(kruskal_test(`Thickness` ~ Yasix,data = df_data), detailed = T))+
#  rotate_x_text(angle = 45)

thickbox
```

#### 6. Line plot
```{r}
thicbox <- ggplot(thickMatrix,aes(x=Yasix, y=mean, color=MaterialName, shape=Status.y))+
#  geom_point(size=1.5)+
  geom_point(mapping = aes(x = Yasix, y = mean), data = thickMatrix, size=5)+
  geom_line(mapping = aes(x = Yasix, y = mean, color=MaterialName, shape=Status.y), data = thickMatrix, size=1.5)+
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=18)+
  theme_classic()+
  labs( y="Thickness (μm)", x="Distance from the edge of A549 spheroid (mm)",
        title = " "
        )+
#  scale_color_discrete(name = "ECM ", labels=c("Compressed","Uncompressed"))+
  scale_shape_discrete(name = "ECM ", labels=c("Compressed","Uncompressed"))+
  easy_center_title()+
#  annotation_custom(textGrob(paste("Cell is ", nlevels(factor(df_data$Cell))), gp=gpar(fontsize=12, fontface="bold")))+
#  scale_y_continuous(guide = "prism_minor",minor_breaks = seq(200, 1800, 100),limits = c(200,1950),expand = c(0,0))+
  scale_y_continuous(expand = c(0,0)
#                     , breaks = seq(0,13,2)
                     )+
  scale_x_continuous(breaks = seq(0,250,50))+
  theme(axis.line = element_line(size = 2),
        axis.ticks = element_line(size = 2),
        axis.ticks.length=unit(0.4, "cm"),
#        prism.ticks.length.y = unit(0.2, "cm"),
        axis.text = element_text(size = 25, face = "bold", color = "black"),
        axis.title.x = element_text(size = 25, face = "bold", hjust = 1),
        axis.title.y = element_text(size=25, face = "bold", hjust = 1),
#        text = element_text(family ="A"),
        legend.position = "None",
        legend.text = element_text(size=25, face = "bold"),
        legend.title = element_text(size=25, face = "bold"),
#        plot.subtitle = element_text(size = 16, face = "bold",hjust = 0.5,colour = "white"),
        plot.title = element_text(size=30, face = "bold"),
        text = element_text(family ="A")
#        axis.title.x.bottom = element_blank()
        )+
  scale_y_break(c(550,3600),scales = 0.8,space = 0.3,expand = FALSE)+
#  scale_y_break(c(20,330),scales = 1.1,space = 0.3, ticklabels = c(0,15,20,330,340,350),expand = FALSE)+
#  geom_hline(yintercept = 7980, size=1.5)+
#  geom_vline(xintercept = 4.588, size=1.3)+
  theme(text = element_text(size=12),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
#        panel.background = element_rect(fill = 'black'),
#        plot.background=element_rect(fill = "black",colour = "black"),
        axis.line = element_line(colour = "black", size = 2),
#        axis.title = element_text(colour = "white"),
#        axis.text = element_text(color = "white"),
        axis.ticks = element_line(colour ="black", size = 2),
#        plot.subtitle = element_text(colour = "white"),
#        legend.background = element_rect(fill = 'black'),
#        legend.text = element_text(colour = 'white'),
#        legend.title = element_text(colour = "white"),
#        plot.title = element_text(colour = "white")
#        legend.position = "top"
  )
#  labs(subtitle = get_test_label(kruskal_test(YoungsModulus ~ Yasix,data = df_data), detailed = T))
#  stat_summary(fun = mean, colour = "red", 
#               position = position_dodge(width = 0.8),
#               geom = "text", vjust = -2.5, 
#               aes(label = round(..y.., digits = 1)), size=5)
thicbox
```


# Youngs Modulus vs. X axis

```{r}
simple.lm(df_data$Xaxis,df_data$YoungsModulus)
summary(lm(YoungsModulus ~ Xaxis, data = df_data))
```

## Thickness vs. X axis

```{r}
simple.lm(df_data$Xaxis,df_data$Thickness)
summary(lm(Thickness ~ Xaxis, data = df_data))
```

## Export the dataset to excel

```{r}
write.xlsx(df_data,file = "stiffness_prepost.xlsx",sheetName = "SpheroidOn")
```

## Update the thickness
```{r}
sqlUpdate(channel,df[,1:15],tablename = "CollagenMembrane", index = "No")
```


## Close and remove channel

```{r}
close(channel)
```

### Combined figure for graduation change
```{r fig.width = 8,fig.height = 4}
windowsFonts(A = windowsFont("Times New Roman"))
figurefor <- ggarrange(print(stiffbox_plan),print(stiffbox), ncol = 2, nrow = 1, widths = c(1,2), font.label = list(size=10, family="A"), common.legend = FALSE)
figurefor
```


### Combined figure
```{r fig.width = 19,fig.height = 3.7}
windowsFonts(A = windowsFont("Times New Roman")) 
figuretot <- ggarrange(
#  print(paperthic)+theme(plot.margin = margin(t = 0,  # Top margin
#                             r = 2.1,  # Right margin
#                             b = -8,  # Bottom margin
#                             l = 4.1) # Left margin
#                       )
#                       ,
  fiberdensity,
 print(stiffbox_plan),
#  ggarrange(print(Coat), print(test)+theme(plot.margin = margin(0, -0.2, 0, 0.2, "cm")),
#            ncol = 1, nrow = 2, labels = c("(B)","(C)"), hjust = 0, vjust = 0.5,font.label = list(size=15,family ="A"), common.legend = TRUE)
#                       print(Coat), 
                       ncol = 2, nrow = 1, widths = c(1,1),  labels = c("(B)","(C)"),font.label = list(size=22,family ="A"), hjust = 0, vjust = 0.95, common.legend = FALSE)
#annotate_figure(figuretot,bottom = text_grob("Distance from the edge of shperoid (mm)", size = 20,hjust = 1, x = 1, face = "bold"
#                                             ,color = "white"
#                                             ))
#  bgcolor("black")
figuretot+
  theme(legend.text = element_text(size = 22))
```
```{r}
ggsave("figuretot.tiff")
```
